## PREPARING THE GATEWAY

### 1. Manual check of Gateway

Gateway has been deployed with the domain `nimbus2-data-pipeline.appspot.com` \
However it is in the process of being completed. Maybe it doesn't have the data we need. We need to make sure we can get the data we need from Gateway. To do this, use a simple HTTP request from console. Of course you can use support tools like `Postman` to make http requests

- Creating a task for fetching data

```bash
# Use http post request
curl -X 'POST' 'https://nimbus2-data-pipeline.appspot.com/api/jobs/reports' \
-H 'accept: application/json' \
-H 'Content-Type: application/json' \
-H 'Authorization: Token <YOUR_ACCESS_TOKEN>' \
-d '{"date_from": "2023-07-25","date_to": "2023-07-26","publisher": "GMB","report_name": "LOCATION_INSIGHTS_V2"}'

# This is just an example with publisher GMB. Feel free to change it according to your needs
# If the post command succeeds and data is returned, pay attention to the id field
{
    ...
    "id": <JOB_ID>,
    ...
}
```

- Getting a result with the id you got

```bash
# Use http get request
curl -L -X 'GET' "https://nimbus2-data-pipeline.appspot.com/api/jobs/reports/<JOB_ID>/results" \
-H 'Authorization: Token <YOUR_ACCESS_TOKEN>'
```

If the response contain the fields you need, then you can start developing. If not, you must to setup gateway locally

### 2. Setup gateway locally

- Step 1 : Follow the steps in README.md file and setup gateway in local \
  https://github.com/leadplusjapan/gateway

- Step 2 : Do [manual check of Gateway](#1-manual-check-of-gateway) again with the following changes
  - Aaccess django admin and generate local access-token
  - Change `nimbus2-data-pipeline.appspot.com` to `127.0.0.1:8000`
  - Use the token you just created to make the request

```bash
# HTTP post request like
curl -X 'POST' 'https://127.0.0.1:8000/api/jobs/reports/' \
-H 'accept: application/json' \
-H 'Content-Type: application/json' \
-H 'Authorization: Token <YOUR_LOCAL_ACCESS_TOKEN>' \
-d '{"date_from": "2023-07-25","date_to": "2023-07-26","publisher": "GMB","report_name": "LOCATION_INSIGHTS_V2"}'
```

It may still not have the fields you need. If so, contact the instructor, they will give you a different version of the library in the requirement. Make the request again. Then you will have the data fields you need

### 3. Connect Airflow to Gateway locally

- Step 1 : Access airflow connection
  - Login Airflow home in here http://localhost:8080/home
  - In menu, select `Admin` => `Connection` => `Edit` at the record where the `Connd Id` is `http_gateway`
- Step 2 : Edit airflow connection \
  When accessing `Edit Connection`, fill in the properties as follows

  - In `Connection Id`, `Connection Type` properties, stay the same
  - In the `Description` properties, you don't need to fill in anything
  - `Login` and `Password` properties must be left blank. Maybe the system will automatically fill in username and password in these 2 fields if you choose to save the password. Please delete it
  - In the remaining properties

    <table>
      <tr>
          <td> <strong> Status </strong> </td>
          <td> <strong> Response </strong> </td>
      </tr>
      <tr>
          <td> Extra </td>
        <td>
        
    ```json
    { "Authorization": "Access-Token <YOUR_LOCAL_ACCESS_TOKEN>" }
    ```
      </td>
      </tr>
      <tr>
          <td> Host </td>
          <td>
            host.docker.internal
          </td>
      </tr>
      <tr>
          <td> Schema </td>
          <td>
            http
          </td>
      </tr>
      <tr>
          <td> Port </td>
          <td>
            8000
          </td>
      </tr>
    </table>

- Step 3 : Checking connection
  - Make sure the gateway locally is running. It will run at port 8000 by default
  - Click the `Test` button, if the connection is successful, you will get the message `Connection successfully tested`. If not, an error message will appear. Please read it and check the previous steps again
  - Click the `Save` button after successful connection

### 4. Update airflow

Based on data obtained from get request, perform the following steps

- Modify the respective classes and queries. Or you can create new ones with new name
- Child class inherit from the parent class. So find the relation between them to modify all that is necessary
- Each query also queries many different tables. Pay attention to the table name if you create a new table and fields data after modifying. Query must follow the [Bigquery Convention](https://reachlocaljapan.atlassian.net/wiki/spaces/PT/pages/917831706/BigQuery+Conventions)

